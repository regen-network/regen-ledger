package core

import (
	"context"

	"github.com/cosmos/cosmos-sdk/orm/types/ormerrors"

	api "github.com/regen-network/regen-ledger/api/regen/ecocredit/v1"
	"github.com/regen-network/regen-ledger/types"
	"github.com/regen-network/regen-ledger/x/ecocredit"
	"github.com/regen-network/regen-ledger/x/ecocredit/core"
)

// CreateProject creates a new project for a specific credit class.
func (k Keeper) CreateProject(ctx context.Context, req *core.MsgCreateProject) (*core.MsgCreateProjectResponse, error) {
	sdkCtx := types.UnwrapSDKContext(ctx)
	classID := req.ClassId
	classInfo, err := k.stateStore.ClassInfoStore().GetByName(ctx, classID)
	if err != nil {
		return nil, err
	}

	err = k.assertClassIssuer(ctx, classInfo.Id, req.Issuer)
	if err != nil {
		return nil, err
	}

	projectID := req.ProjectId
	if projectID == "" {
		exists := true
		for ; exists; sdkCtx.GasMeter().ConsumeGas(gasCostPerIteration, "project id sequence") {
			projectID, err = k.genProjectID(ctx, classInfo.Id, classInfo.Name)
			if err != nil {
				return nil, err
			}
			exists, err = k.stateStore.ProjectInfoStore().HasByClassIdName(ctx, classInfo.Id, projectID)
			if err != nil {
				return nil, err
			}
		}
	}

	if err = k.stateStore.ProjectInfoStore().Insert(ctx, &api.ProjectInfo{
		Name:            projectID,
		ClassId:         classInfo.Id,
		ProjectLocation: req.ProjectLocation,
		Metadata:        req.Metadata,
	}); err != nil {
		return nil, err
	}

	if err := sdkCtx.EventManager().EmitTypedEvent(&core.EventCreateProject{
		ClassId:         classID,
		ProjectId:       projectID,
		Issuer:          req.Issuer,
		ProjectLocation: req.ProjectLocation,
	}); err != nil {
		return nil, err
	}

	return &core.MsgCreateProjectResponse{
		ProjectId: projectID,
	}, nil
}

// genProjectID generates a projectID when no projectID was given for CreateProject.
// The ID is generated by concatenating the classID and a sequence number.
func (k Keeper) genProjectID(ctx context.Context, classRowID uint64, classID string) (string, error) {
	var nextID uint64
	projectSeqNo, err := k.stateStore.ProjectSequenceStore().Get(ctx, classRowID)
	switch err {
	case ormerrors.NotFound:
		nextID = 1
	case nil:
		nextID = projectSeqNo.NextProjectId
	default:
		return "", err
	}

	if err = k.stateStore.ProjectSequenceStore().Save(ctx, &api.ProjectSequence{
		ClassId:       classRowID,
		NextProjectId: nextID + 1,
	}); err != nil {
		return "", err
	}

	return ecocredit.FormatProjectID(classID, nextID), nil
}
